# Copyright (C) 2022 Ing <https://github.com/wjz304>
# 
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#


name: Custom Redpill
on:
  issues:
    types: [opened, reopened]
  workflow_dispatch:
    inputs:
      body: 
        description: 'issuss body'
        required: true
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Create Issues comment
        if: github.event_name == 'issues'
        id: comment
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: | 
            åˆ†æ title å’Œ body å†…å®¹ ..  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
          emoji: heart

      - name: Set up Ruby 3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.2

      - name: Set up Python 3
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Init Env
        run : |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"
          python -m pip install --upgrade pip setuptools
          python -m pip install requests
      - name: Get Issues Info
        if: github.event_name == 'issues'
        id: get-issues
        uses: actions/github-script@v6
        with:
          script: |
            // '<???>': æ›¿æ¢ä¸€æ¬¡; '/<???>/g': æ›¿æ¢å…¨å±€; '/<???>/gi': æ›¿æ¢å…¨å±€å¹¶å¿½ç•¥å¤§å°å†™; 
            // \u0008 \b Backspace
            // \u0009 \t Tab
            // \u000A \n æ¢è¡Œç¬¦
            // \u000B \v å‚ç›´åˆ¶è¡¨ç¬¦
            // \u000C \f æ¢é¡µ
            // \u000D \r å›è½¦
            // \u0022 \" åŒå¼•å· (")
            // \u0027 \' å•å¼•å· (')
            // \u005C \\ åæ–œæ  (\)
            // \u00A0    ä¸é—´æ–­ç©ºæ ¼
            // \u2028    è¡Œåˆ†éš”ç¬¦
            // \u2029    æ®µè½åˆ†éš”ç¬¦
            // \uFEFF    å­—èŠ‚é¡ºåºæ ‡è®°
            var fs = require('fs'); // å¼•å…¥fsæ¨¡å—
            var issuenumber = ${{ toJSON(github.event.issue.number) }};
            var issueauth = ${{ toJSON(github.event.issue.user.login) }};
            var issuetitle = ${{ toJSON(github.event.issue.title) }};
            var issuebody = ${{ toJSON(github.event.issue.body) }};
            if (issuetitle != null) {
              issuetitle = issuetitle.replace(/\u000A|\u000D/g, "");  // æ¢è¡Œç¬¦,å›è½¦
            }
            
            if (issuebody != null) {
              // Backspace,Tab,å‚ç›´åˆ¶è¡¨ç¬¦,æ¢é¡µ,å›è½¦,ä¸é—´æ–­ç©ºæ ¼,è¡Œåˆ†éš”ç¬¦,æ®µè½åˆ†éš”ç¬¦,å­—èŠ‚é¡ºåºæ ‡è®°
              issuebody = issuebody.replace(/\u0008|\u0009|\u000B|\u000C|\u000D|\u00A0|\u2028|\u2029|\uFEFF/g, "");
              
              // å®¹é”™
              issuebody = issuebody.replace(/ï¼š/g, ": ");
              issuebody = issuebody.replace(/ï¼Œ/g, ", ");
              issuebody = issuebody.replace(/â€œ|â€/g, "\"");
              fs.writeFileSync(`body#${issuenumber}.txt`, issuebody, { 'flag': 'w' }, (err) => { if (err) throw err; });
            
              var regex = /\`\`\`([\s\S]*?)\`\`\`/g;
              let options = issuebody.match(regex);
              if (options != null && options.length > 0) {
                fs.writeFileSync('customshell.sh', options[options.length-1].replace(/\`/g, ""), { 'flag': 'w' }, (err) => { if (err) throw err; });
                for(option in options) {
                  console.log(options[option]);
                  issuebody = issuebody.replace(options[option], "");
                }
              }
              // æ¢è¡Œç¬¦
              issuebody = issuebody.replace(/\u000A/g, "");
            }
            core.setOutput("issuenumber", JSON.stringify(issuenumber));
            core.setOutput("issueauth", JSON.stringify(issueauth));
            core.setOutput("issuetitle", JSON.stringify(issuetitle));
            core.setOutput("issuebody", JSON.stringify(issuebody));
      - name: Set Issues Info
        if: github.event_name == 'issues' && success()
        run: |
          echo issuenumber: '${{ steps.get-issues.outputs.issuenumber }}'
          echo issueauth:   '${{ steps.get-issues.outputs.issueauth }}'
          echo issuetitle:  '${{ steps.get-issues.outputs.issuetitle }}'
          echo issuebody:   '${{ steps.get-issues.outputs.issuebody }}'
          echo "issuenumber="${{ steps.get-issues.outputs.issuenumber }}"" >> $GITHUB_ENV
          echo "issueauth="${{ steps.get-issues.outputs.issueauth }}"" >> $GITHUB_ENV
          echo "issuetitle="${{ steps.get-issues.outputs.issuetitle }}"" >> $GITHUB_ENV
          echo "issuebody="${{ steps.get-issues.outputs.issuebody }}"" >> $GITHUB_ENV
          if [ -f 'customshell.sh' ]; then
            echo "customshell.sh"
            cat customshell.sh
          fi
      - name: Get Build Info
        shell: python
        run: |
          # -*- coding: utf-8 -*-
          import os, re, json, shutil, string, requests, subprocess
          def set_output(name, value):
              subprocess.call(["echo '{}={}' >> $GITHUB_ENV".format(name, value)], shell=True)
          if __name__ == '__main__':
              issues = 'false'
              iscustom = 'true'
              errinfo = ''
              warinfo = ''
              repository = ''
              model = ''
              version = ''
              platform = ''
              lkm = ''
              config = ''
              maxdisks = ''
              maxlanport = ''
              internalportcfg = ''
              esataportcfg = ''
              usbportcfg = ''
              sn = ''
              mac = ''
              netif_num = ''
              vid = ''
              pid = ''
              diskidxmap = ''
              sataportmap = ''
              sasidxmap = ''
              dtb = ''
              addons = ''
              modules = ''
              ext3rds = ''
              dev = '0'
              try:
                  body = {}
                  bodyOriginal = {}
                  if '${{ github.event_name }}' == 'issues':
                      if '${{ env.issuetitle }}'.lower().startswith('custom'):
                          issues = 'true'
                          bodyOriginal = json.loads('${{ env.issuebody }}')
                      else:
                          iscustom = 'false'
                  else:
                      bodyOriginal = json.loads('${{ inputs.body }}')
                  for k, v in bodyOriginal.items():
                    body[k.lower()] = v
                  if len(body) == 0:
                      iscustom = 'false'
                      errinfo = 'body é”™è¯¯, body is null'
                  else:
                      # l = lambda x: x.strip() if isinstance(x, str) else str(x)
                      if 'repository' in body: repository = body['repository'].strip()
                      if 'model' in body: model = body['model'].strip()
                      if 'version' in body: version = body['version'].strip()
                      # if 'platform' in body: platform = body['platform'].strip()
                      if 'lkm' in body: lkm = body['lkm'].strip()
                      if 'config' in body: config = body['config'] #l(body['config']).strip()
                      
                      if 'maxdisks' in body: maxdisks = body['maxdisks'].strip()
                      if 'maxlanport' in body: maxlanport = body['maxlanport'].strip()
                      if 'internalportcfg' in body: internalportcfg = body['internalportcfg'].strip()
                      if 'esataportcfg' in body: esataportcfg = body['esataportcfg'].strip()
                      if 'usbportcfg' in body: usbportcfg = body['usbportcfg'].strip()
                      #if 'sn' in body: sn = body['sn'].strip()
                      #if 'mac' in body: mac = body['mac'].strip()
                      if 'netif_num' in body: netif_num = body['netif_num'].strip()
                      if 'vid' in body: vid = body['vid'].strip()
                      if 'pid' in body: pid = body['pid'].strip()
                      if 'diskidxmap' in body: diskidxmap = body['diskidxmap'].strip()
                      if 'sataportmap' in body: sataportmap = body['sataportmap'].strip()
                      if 'sasidxmap' in body: sasidxmap = body['sasidxmap'].strip()
                      if 'dtb' in body: dtb = body['dtb'].strip()
                      if 'addons' in body: addons = body['addons'].strip()
                      if 'modules' in body: modules = body['modules'].strip()
                      if 'ext3rds' in body: ext3rds = body['ext3rds'].strip()
              except Exception as e:
                  iscustom = 'false'
                  errinfo = 'body é”™è¯¯, ä¸ç¬¦åˆJSONè§„èŒƒ {}.'.format(e)
              loads = {}
              with open('docs/loads.json', mode="r", encoding='utf-8') as f:
                  loads = json.loads(f.read())
              repositorys = loads.keys()
              if iscustom == 'true' and not repository in repositorys:
                  iscustom = 'false'
                  errinfo = 'repository å‚æ•°é”™è¯¯, å½“å‰ä»…æ”¯æŒ {}.'.format(', '.join(repositorys))
              if iscustom == 'true':
                  models = loads[repository].keys()
                  if not model in models:
                      iscustom = 'false'
                      errinfo = 'model å‚æ•°é”™è¯¯, å½“å‰ä»…æ”¯æŒ {}.'.format(', '.join(models))
              if iscustom == 'true':
                  versions = loads[repository][model]
                  if not version in versions:
                      iscustom = 'false'
                      errinfo = 'version å‚æ•°é”™è¯¯, å½“å‰ä»…æ”¯æŒ {}.'.format(', '.join(versions))
              if iscustom == 'true':
                  models = {}
                  with open('docs/models.json', mode="r", encoding='utf-8') as f:
                      models = json.loads(f.read())
                  toolchain = {}
                  with open('docs/toolchain.json', mode="r", encoding='utf-8') as f:
                      toolchain = json.loads(f.read())
                  PackageArch = [ item["PackageArch"] for item in models if item["Model"] == model ][0]
                  PackageKVer = [ toolchain[item][PackageArch] for item in toolchain if item[0:3] == version[0:3] ][0]
                  platform = PackageArch + "-" + PackageKVer
              if iscustom == 'true':
                  lkms = []
                  with open('docs/parameter.json', mode="r", encoding='utf-8') as f:
                      parameter = json.loads(f.read())
                      lkms = parameter['lkm']['options']
                  if lkm == '':
                      lkm = lkms[0]
                  if not lkm in lkms:
                      iscustom = 'false'
                      errinfo = 'lkm å‚æ•°é”™è¯¯, å½“å‰ä»…æ”¯æŒ {}.'.format(', '.join(lkms))
              if config != '':
                  try:
                      if isinstance(config, str):
                          config = json.loads(config)
                      if isinstance(config, dict):
                          config = json.dumps(config)
                          json.loads(config)
                      else:
                          if iscustom == 'true':
                              iscustom = 'false'
                              errinfo = 'config å‚æ•°é”™è¯¯, ä¸ç¬¦åˆJSONè§„èŒƒ.'
                  except Exception as e:
                      if iscustom == 'true':
                          iscustom = 'false'
                          errinfo = 'config å‚æ•°é”™è¯¯, ä¸ç¬¦åˆJSONè§„èŒƒ {}.'.format(e)
              if iscustom == 'true' and maxdisks != '' and (not maxdisks.isdigit() or int(maxdisks) < 1 or int(maxdisks) > 48):
                  iscustom = 'false'
                  errinfo = 'maxdisks å‚æ•°é”™è¯¯, è¯·å¡«å†™ 1 - 48 ä¹‹é—´çš„æ•°å­—.'
              if iscustom == 'true' and maxlanport != '' and (not maxlanport.isdigit() or int(maxlanport) < 0 or int(maxlanport) > 47):
                  iscustom = 'false'
                  errinfo = 'maxlanport å‚æ•°é”™è¯¯, è¯·å¡«å†™ 0 - 47 ä¹‹é—´çš„æ•°å­—.'
              if iscustom == 'true' and internalportcfg != '':
                  if len(internalportcfg) > 2 and internalportcfg[:2].lower().startswith('0x') and all(c in string.hexdigits for c in internalportcfg[2:]):
                      pass
                  elif all(c in string.hexdigits for c in internalportcfg):
                      internalportcfg = '0x' + internalportcfg
                  else:
                      iscustom = 'false'
                      errinfo = 'internalportcfg å‚æ•°é”™è¯¯, è¯·å¡«å†™åå…­è¿›åˆ¶æ•°.'
              if iscustom == 'true' and esataportcfg != '':
                  if len(esataportcfg) > 2 and esataportcfg[:2].lower().startswith('0x') and all(c in string.hexdigits for c in esataportcfg[2:]):
                      pass
                  elif all(c in string.hexdigits for c in esataportcfg):
                      esataportcfg = '0x' + esataportcfg
                  else:
                      iscustom = 'false'
                      errinfo = 'esataportcfg å‚æ•°é”™è¯¯, è¯·å¡«å†™åå…­è¿›åˆ¶æ•°.'
              if iscustom == 'true' and usbportcfg != '':
                  if len(usbportcfg) > 2 and usbportcfg[:2].lower().startswith('0x') and all(c in string.hexdigits for c in usbportcfg[2:]):
                      pass
                  elif all(c in string.hexdigits for c in usbportcfg):
                      usbportcfg = '0x' + usbportcfg
                  else:
                      iscustom = 'false'
                      errinfo = 'usbportcfg å‚æ•°é”™è¯¯, è¯·å¡«å†™åå…­è¿›åˆ¶æ•°.'
              if iscustom == 'true' and sn != '':
                  warinfo = 'sn'
                  if not sn.isalnum():
                      iscustom = 'false'
                      errinfo = 'sn å‚æ•°é”™è¯¯.'
                      warinfo = 'sn'
              if iscustom == 'true' and mac != '':
                  warinfo = 'mac' if warinfo == '' else 'sn, mac'
                  macs = [x.strip() for x in re.split(',| |\|', mac) if x.strip() != '']
                  if len(macs) > 0 or len(macs) <= 8:
                      mac = ','.join(macs)
                  else:
                      iscustom = 'false'
                      errinfo = 'mac å‚æ•°é”™è¯¯.'
              if iscustom == 'true' and netif_num != '' and (not netif_num.isdigit() or int(netif_num) < 1 or int(netif_num) > 8):
                  iscustom = 'false'
                  errinfo = 'netif_num å‚æ•°é”™è¯¯, è¯·å¡«å†™ 1 - 8 ä¹‹é—´çš„æ•°å­—.'
              if iscustom == 'true' and mac != '' and netif_num != '' and int(netif_num) != len(mac.split(',')):
                  iscustom = 'false'
                  errinfo = 'netif_num åº”è¯¥ä¸ mac çš„ä¸ªæ•°ç›¸ç­‰, è¯·å¡«å†™åŒ¹é…çš„æ•°å€¼.'
              if iscustom == 'true' and vid != '':
                  if len(vid) == 6 and vid.lower().startswith('0x') and all(c in string.hexdigits for c in vid[2:]):
                      pass
                  elif len(vid) == 4 and all(c in string.hexdigits for c in vid):
                      vid = '0x' + vid
                  else:
                      iscustom = 'false'
                      errinfo = 'vid å‚æ•°é”™è¯¯, è¯·å¡«å†™åå…­è¿›åˆ¶æ•°.'
              if iscustom == 'true' and pid != '':
                  if len(pid) == 6 and pid.lower().startswith('0x') and all(c in string.hexdigits for c in pid[2:]):
                      pass
                  elif len(pid) == 4 and all(c in string.hexdigits for c in pid):
                      pid = '0x' + pid
                  else:
                      iscustom = 'false'
                      errinfo = 'pid å‚æ•°é”™è¯¯, è¯·å¡«å†™åå…­è¿›åˆ¶æ•°.'
              if iscustom == 'true' and ((vid != '' and pid == '') or (vid == '' and pid != '')):
                  iscustom = 'false'
                  errinfo = 'vid å’Œ pid å‚æ•°ä¸å¯å•ç‹¬å®šåˆ¶, åº”æˆå¯¹å‡ºç°, è¯·å¡«å†™å®Œæ•´çš„ä¸¤ä¸ªå‚æ•°.'
              if iscustom == 'true' and diskidxmap != '' and not all(c in string.hexdigits for c in diskidxmap):
                  iscustom = 'false'
                  errinfo = 'diskidxmap å‚æ•°é”™è¯¯, è¯·å¡«å†™åå…­è¿›åˆ¶æ•°..'
              
              if iscustom == 'true' and sataportmap != '' and not sataportmap.isdigit():
                  iscustom = 'false'
                  errinfo = 'sataportmap å‚æ•°é”™è¯¯, è¯·å¡«å†™æ•°å­—.'
              
              if iscustom == 'true' and sasidxmap != '' and not sasidxmap.isdigit():
                  iscustom = 'false'
                  errinfo = 'sasidxmap å‚æ•°é”™è¯¯, è¯·å¡«å†™æ•°å­—.'
              #if iscustom == 'true' and ((diskidxmap != '' and sataportmap == '') or (diskidxmap == '' and sataportmap != '') or len(diskidxmap) < len(sataportmap)):
              #    iscustom = 'false'
              #    errinfo = 'diskidxmap å’Œ sataportmap å‚æ•°ä¸å¯å•ç‹¬å®šåˆ¶, ä¸” diskidxmapçš„ä½æ•°åº”è¯¥ä¸ºsataportmapä½æ•°çš„2å€.'
              if iscustom == 'true' and dtb != '': # and dtb != 'auto':
                  url = dtb
                  try:
                      try:
                          import wget, filetype
                      except ModuleNotFoundError:
                          os.system('pip3 install wget filetype')
                          import wget, filetype
                  
                      res = wget.download(url)
                      if res:
                          down = res
                          kind = filetype.guess(down)
                          name = 'user'
                          if os.path.exists('extract'):  
                              shutil.rmtree('extract')
                          if kind != None and kind.extension == 'zip':
                              import zipfile
                              z = zipfile.ZipFile(down, 'r')
                              z.extractall('extract')
                          if kind != None and kind.extension in ['tar', 'gz']:
                              import tarfile
                              z = tarfile.open(down) 
                              z.extractall('extract')
                          if os.path.exists('extract'):
                              isfind = False
                              for root, dirs, files in os.walk('extract'):
                                  for file in files:
                                      if file.endswith('.dts') or file.endswith('.dtb'):
                                          isfind = True
                                          down = name + os.path.splitext(file)[-1]
                                          shutil.move(os.path.join(root, file), down)
                                          break
                                  if isfind is True:
                                      break
                          if os.path.exists(down) and (down.endswith('dts') or down.endswith('dtb')):
                              if down.endswith('dts'):
                                  wget.download('https://raw.githubusercontent.com/pocopico/rp-ext/main/redpill-dtb-static/releases/dtc')
                                  if os.path.exists('dtc'):
                                      print('./dtc -q -I dts -O dtb {} >{}.dtb'.format(down, name))
                                      os.system('sudo chmod a+x dtc')
                                      # os.system('sudo ./dtc -q -I dts -O dtb {} >{}.dtb'.format(down, name))
                                      p = subprocess.Popen('sudo ./dtc -q -I dts -O dtb {} >{}.dtb'.format(down, name), shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
                                      errinfo = p.stderr.read().decode('utf-8')
                                      if os.path.exists('{}.dtb'.format(name)) and os.path.getsize('{}.dtb'.format(name)) > 0:
                                          print('dtc ok ...')
                                          dtb = os.path.abspath('{}.dtb'.format(name))
                                      else:
                                          iscustom = 'false'
                                          errinfo = 'dtb å‚æ•°é”™è¯¯, dtsæ–‡ä»¶å†…å®¹å­˜åœ¨é”™è¯¯ <{}>.'.format(errinfo.
                                          lace('\r', '').replace('\n', ' '))
                                  else:
                                      iscustom = 'false'
                                      errinfo = 'dtb å‚æ•°é”™è¯¯, ä¸‹è½½ dtc(dts->dtb tools) å¤±è´¥, å¯èƒ½æ˜¯æœåŠ¡å™¨å‹åŠ›è¿‡å¤§, è¯·ç¨åé‡è¯•, æˆ–è€…ç›´æ¥ä½¿ç”¨ dtb æ–‡ä»¶è·³è¿‡è½¬æ¢.'
                              else:
                                  dtb = os.path.abspath(down)
                          else:
                              iscustom = 'false'
                              errinfo = 'dtb å‚æ•°é”™è¯¯, è¯¥urlä¸‹è½½çš„æ–‡ä»¶ä¸æ˜¯æ‰€æ”¯æŒçš„æ ¼å¼.'
                  except ValueError as e:
                      iscustom = 'false'
                      errinfo = 'dtb å‚æ•°é”™è¯¯, {}, è¯·å¡«å†™ dts/dtb æ–‡ä»¶æœ‰æ•ˆçš„ http(s) ä¸‹è½½é“¾æ¥.'.format(e)
                  except Exception as e:
                      iscustom = 'false'
                      errinfo = 'dtb å‚æ•°é”™è¯¯, {}, è¯·ç¨åé‡è¯•.'.format(e)
              if iscustom == 'true' and addons != '':
                  req = requests.get('https://raw.githubusercontent.com/wjz304/rp-ext/main/addons.json')
                  req.encoding = 'utf-8'
                  gitAddons = json.loads(req.text)
                  curAddons = [ x.strip() for x in re.split(',| |\|', addons) if x.strip() != '' ]
                  extc = [ x for x in curAddons if x not in gitAddons.keys() or (platform not in gitAddons[x]['platforms'] and '_' not in gitAddons[x]['platforms']) ]
                  if len(extc) > 0:
                      iscustom = 'false'
                      errinfo = 'ext å‚æ•°é”™è¯¯, "{}" æ— æ•ˆ, addons å½“å‰ä»…æ”¯æŒ "{}".'.format(extc, ','.join([x for x in curAddons if x in gitAddons.keys() and (platform in gitAddons[x]['platforms'] or '_' in gitAddons[x]['platforms'])]))
                  else:
                      dtbs = ['DS920+', 'DS923+', 'DS1520+', 'DS1621+', 'DS1821+', 'DS2422+', 'DVA1622', 'FS2500', 'SA6400']
                      if model in dtbs:
                          if dtb == '':
                              if 'dtbstatic' in curAddons:
                                  iscustom = 'false'
                                  errinfo = 'addons å‚æ•°é”™è¯¯, "dtbstatic" æ— æ•ˆ, dtbstatic ä¾èµ–è‡ªå®šä¹‰çš„ dtb æ–‡ä»¶.'
                              elif 'disks' in curAddons and 'dtbpatch' in curAddons:
                                  iscustom = 'false'
                                  errinfo = 'addons å‚æ•°é”™è¯¯, "disks" å’Œ "dtbpatch" åªèƒ½é€‰ä¸€ä¸ª.'
                              elif 'disks' not in curAddons and 'dtbpatch' not in curAddons:
                                  curAddons.append('disks')
                          else:
                              if 'disks' in curAddons or 'dtbpatch' in curAddons:
                                  iscustom = 'false'
                                  errinfo = 'addons å‚æ•°é”™è¯¯, "disks / dtbpatch" æ— æ•ˆ, è‡ªå®šä¹‰ dtb æ–‡ä»¶æ—¶åªèƒ½é€‰ "dtbstatic".'
                              elif 'dtbstatic' not in curAddons:
                                  curAddons.append('dtbstatic')
                      else:
                          if 'dtbstatic' in curAddons or 'disks' in curAddons or 'dtbpatch' in curAddons:
                              iscustom = 'false'
                              errinfo = 'addons å‚æ•°é”™è¯¯, "dtbstatic / disks / dtbpatch" æ— æ•ˆ, "{}" ä¸éœ€è¦ "dtb".'.format(model)
                      if iscustom == 'true' and addons != '':
                          addons = ','.join(curAddons)
              if iscustom == 'true' and modules != '':
                  req = requests.get('https://raw.githubusercontent.com/wjz304/rp-ext/main/modules.json')
                  req.encoding = 'utf-8'
                  gitModules = json.loads(req.text)
                  curModules = [ x.strip() for x in re.split(',| |\|', modules) if x.strip() != '' ]
                  extc = [ x for x in curModules if x not in gitModules.keys() or (platform not in gitModules[x]['platforms'] and '_' not in gitModules[x]['platforms']) ]
                  if len(extc) > 0:
                      iscustom = 'false'
                      errinfo = 'ext å‚æ•°é”™è¯¯, "{}" æ— æ•ˆ, modules å½“å‰ä»…æ”¯æŒ "{}".'.format(extc, ','.join([x for x in curModules if x in gitModules.keys() and (platform in gitModules[x]['platforms'] or '_' in gitModules[x]['platforms'])]))
                  else:
                      modules = ','.join(curModules)
              if iscustom == 'true' and ext3rds != '':
                  ext3rds = [ x.strip() for x in re.split(',| |\|', ext3rds) if x.strip() != '' ]
                  extc = [ x for x in ext3rds if not x.startswith('http') ]
                  if len(extc) > 0:
                      iscustom = 'false'
                      errinfo = 'ext3rds å‚æ•°é”™è¯¯, "{}" æ— æ•ˆ, ext3rds å½“å‰ä»…æ”¯æŒ url åœ°å€.'.format(extc)
                  else:
                      ext3rds = ','.join(ext3rds)
              if iscustom == 'true' and addons == '' and modules == '' and ext3rds == '':
                  addons = 'boot-wait'   # å½“ä¸€ä¸ª ext éƒ½æ²¡æœ‰æ—¶ /include/file.sh ä¸­ rpt_list_directories ç›´æ¥ "exit 1"
              if iscustom == 'true' and not dev in ['0', '1']:
                  dev = '0'
              set_output('issues', issues)
              set_output('iscustom', iscustom)
              set_output('errinfo', errinfo)
              set_output('warinfo', warinfo)
              set_output('repository', repository)
              set_output('model', model)
              set_output('version', version)
              set_output('platform', platform)
              set_output('lkm', lkm)
              set_output('config', config)
              set_output('maxdisks', maxdisks)
              set_output('maxlanport', maxlanport)
              set_output('internalportcfg', internalportcfg)
              set_output('esataportcfg', esataportcfg)
              set_output('usbportcfg', usbportcfg)
              set_output('sn', sn)
              set_output('mac', mac)
              set_output('netif_num', netif_num)
              set_output('vid', vid)
              set_output('pid', pid)
              set_output('diskidxmap', diskidxmap)
              set_output('sataportmap', sataportmap)
              set_output('sasidxmap', sasidxmap)
              set_output('dtb', dtb)
              set_output('addons', addons)
              set_output('modules', modules)
              set_output('ext3rds', ext3rds)
              
              set_output('dev', dev)
      - name: Echo Build Info
        run: |
          echo issues:            '${{ env.issues }}'
          echo iscustom:          '${{ env.iscustom }}'
          echo errinfo:           '${{ env.errinfo }}'
          echo warinfo:           '${{ env.warinfo }}'
          echo repository:        '${{ env.repository }}'
          echo model:             '${{ env.model }}'
          echo version:           '${{ env.version }}'
          echo platform:          '${{ env.platform }}'
          echo lkm:               '${{ env.lkm }}'
          echo config:            '${{ env.config }}'
          echo maxdisks:          '${{ env.maxdisks }}'
          echo maxlanport:        '${{ env.maxlanport }}'
          echo internalportcfg:   '${{ env.internalportcfg }}'
          echo esataportcfg:      '${{ env.esataportcfg }}'
          echo usbportcfg:        '${{ env.usbportcfg }}'
          echo sn:                '${{ env.sn }}'
          echo mac:               '${{ env.mac }}'
          echo netif_num:         '${{ env.netif_num }}'
          echo vid:               '${{ env.vid }}'
          echo pid:               '${{ env.pid }}'
          echo diskidxmap:        '${{ env.diskidxmap }}'
          echo sataportmap:       '${{ env.sataportmap }}'
          echo sasidxmap:         '${{ env.sasidxmap }}'
          echo dtb:               '${{ env.dtb }}'
          echo addons:            '${{ env.addons }}'
          echo modules:           '${{ env.modules }}'
          echo ext3rds:           '${{ env.ext3rds }}'
          echo dev:               '${{ env.dev }}'
      - name: Add Issues labels
        if: env.issues == 'true' && env.iscustom == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'add-labels'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}
          labels: 'custom,${{ env.model }}'

      - name: Update Comment Begin
        if: env.issues == 'true' && env.iscustom == 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} æ‚¨å¥½.  
            æ‚¨è‡ªå®šä¹‰çš„ Redpill å·²å¼€å§‹æ„å»º. è¯·å‰å¾€ä¸‹é¢çš„ URL æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯.  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
          emoji: heart

      - name: Update Comment Error
        if: env.issues == 'true' && env.iscustom == 'false'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} æ‚¨å¥½.  
            æ‚¨è‡ªå®šä¹‰ Redpill æ‰€å¡«å†™çš„ä¿¡æ¯æœ‰è¯¯, æ— æ³•è§¦å‘ç¼–è¯‘, è¯·å‚è€ƒæ¨¡æ¿å’Œé”™è¯¯æç¤ºå¯¹bodyè¿›è¡Œä¿®æ”¹å¹¶è¯·é‡æ–°è§¦å‘ç¼–è¯‘(Close & Reopen).  
            `Error Info:`  
            `${{ env.errinfo }}`  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
          emoji: confused

      - name: Update Comment Warinfo
        if: env.issues == 'true' && env.warinfo != ''
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: append
          body: |
            >
            ----
            â€¼ï¸â€¼ï¸â€¼ï¸ 
            `Body ä¸­å«æœ‰è‡ªå®šä¹‰çš„ ${{ env.warinfo }} æ•æ„Ÿä¿¡æ¯, ä¸ºé˜²æ­¢å…¶ä»–äººç›—ç”¨, å»ºè®®å‚è€ƒä»¥ä¸‹è§†é¢‘åˆ é™¤æ•æ„Ÿä¿¡æ¯(ä¸å½±å“æœ¬æ¬¡ç¼–è¯‘).`  
              
            https://user-images.githubusercontent.com/5615843/187615519-53a6dcf5-a5e2-4731-8889-9eee8955a977.mp4  
            >
            ----
          emoji: eyes

      - name: Update Comment Invalid
        if: env.issues == 'false'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} æ‚¨å¥½.  
            æ ¹æ® title å’Œ body å†…å®¹çš„åˆ†æ, è¯¥ Issue å¹¶éå®šåˆ¶ Redpill. å°†åœ¨ç®¡ç†å‘˜çœ‹åˆ°åä¼šè¿›è¡Œå›å¤.  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ----
          emoji: eyes

      - name: Create Config File
        if: env.iscustom == 'true'
        shell: python
        run: |
          import os, json
          if __name__ == '__main__':
              config = {
                  "extra_cmdline": {
                      "pid": "0x0001",
                      "vid": "0x46f4",
                      "sn": "",
                      "mac1": ""
                  },
                  "synoinfo": {
                      "internalportcfg": "0xffff",
                      "maxlanport": "7"
                  },
                  "ramdisk_copy": {}
              }
              dat = []
              if '${{ env.sn }}' == '' or '${{ env.mac }}' == '':
                  model = '${{ env.model }}'
                  dat = os.popen('bash ./serialnumbergen.sh {}'.format(model)).readlines()
              if '${{ env.config }}' != '':
                  inconfig = json.loads('${{ env.config }}')
                  config.update(inconfig)
              if not "extra_cmdline" in config:
                  config["extra_cmdline"] = {}
              if '${{ env.vid }}' != '':
                  config["extra_cmdline"]["vid"] = '${{ env.vid }}'
              if '${{ env.pid }}' != '':
                  config["extra_cmdline"]["pid"] = '${{ env.pid }}'
              if '${{ env.sn }}' != '':
                  config["extra_cmdline"]["sn"] = '${{ env.sn }}'
              if config["extra_cmdline"]["sn"] == '' and len(dat) == 2:
                  config["extra_cmdline"]["sn"] = dat[1].strip()
              if '${{ env.mac }}' != '':
                  macs = '${{ env.mac }}'.split(',')
                  for index, item in enumerate(macs):
                      config["extra_cmdline"]["mac{}".format(index+1)] = item.replace(':', '').upper()
                  config["extra_cmdline"]["netif_num"] = len(macs)
              else:
                  netnum = 2
                  if '${{ env.netif_num }}' != '':
                      netnum = int('${{ env.netif_num }}')
                  if len(dat) == 2:
                      for index in range(netnum):
                          config["extra_cmdline"]["mac{}".format(index+1)] = hex(int(dat[0].strip().replace(':', ''), 16) + index)[2:].rjust(12,'0').upper()
                      config["extra_cmdline"]["netif_num"] = netnum
              if '${{ env.diskidxmap }}' != '':
                  config["extra_cmdline"]["DiskIdxMap"] = '${{ env.diskidxmap }}'
              if '${{ env.sataportmap }}' != '':
                  config["extra_cmdline"]["SataPortMap"] = '${{ env.sataportmap }}'
              if '${{ env.sasidxmap }}' != '':
                  config["extra_cmdline"]["SasIdxMap"] = '${{ env.sasidxmap }}'
              if not "synoinfo" in config:
                  config["synoinfo"] = {}
              if '${{ env.maxdisks }}' != '':
                  config["synoinfo"]["maxdisks"] = '${{ env.maxdisks }}'
              if '${{ env.maxlanport }}' != '':
                  config["synoinfo"]["maxlanport"] = '${{ env.maxlanport }}'
              if '${{ env.internalportcfg }}' != '':
                  config["synoinfo"]["internalportcfg"] = '${{ env.internalportcfg }}'
              if '${{ env.esataportcfg }}' != '':
                  config["synoinfo"]["esataportcfg"] = '${{ env.esataportcfg }}'
              if '${{ env.usbportcfg }}' != '':
                  config["synoinfo"]["usbportcfg"] = '${{ env.usbportcfg }}'
              print(json.dumps(config, indent=4))
              with open('user_config.json', 'w', encoding="utf-8") as f:
                  f.write(json.dumps(config, indent=4))
      - name: Run Build
        if: env.iscustom == 'true' && success()
        run: |
          # ç´¯äº†, æ¯ç­å§
          #
          # # curl å‚æ•°è¯´æ˜
          # -f, --fail              è¿æ¥å¤±è´¥æ—¶ä¸æ˜¾ç¤ºHTTPé”™è¯¯ä¿¡æ¯ (H)
          # -k, --insecure          å…è®¸è¿æ¥åˆ° SSL ç«™ç‚¹ï¼Œè€Œä¸ä½¿ç”¨è¯ä¹¦ (H)
          # -L, --location          è·Ÿè¸ªé‡å®šå‘ (H)
          # -o, --output FILE       å°†è¾“å‡ºå†™å…¥æ–‡ä»¶ï¼Œè€Œé stdout
          # -O, --remote-name       å°†è¾“å‡ºå†™å…¥è¿œç¨‹æ–‡ä»¶
          # -S, --show-error        æ˜¾ç¤ºé”™è¯¯. åœ¨é€‰é¡¹ -s ä¸­ï¼Œå½“ curl å‡ºç°é”™è¯¯æ—¶å°†æ˜¾ç¤º
          # -s, --silent            Silentæ¨¡å¼ã€‚ä¸è¾“å‡ºä»»åŠ¡å†…å®¹
          # -w, --write-out FORMAT  å®Œæˆåè¾“å‡ºä»€ä¹ˆ
          # -#/--progress-bar	      ç”¨è¿›åº¦æ¡æ˜¾ç¤ºå½“å‰çš„ä¼ é€çŠ¶æ€
          sudo apt update
          #sudo apt upgrade -y
          sudo apt install bspatch jq -y    # curl æ–°ç‰ˆæœ‰æ¯›ç—…
          sudo apt install rename tree -y   # typo ä¾èµ–
          function exdsmpat() {
            model=$1
            version=$2
            synomodel=$(echo ${model,,} | sed 's/+/p/g')                                   # DS3622xs+ => ds3622xsp
            synoversion=$(echo ${version} | awk -F - '{print $2}')                         # 7.0.1-42218 => 42218
            
            configfile=./config/${model}/${version}/config.json
            paturl=$(cat ${configfile} | jq -r '.os .pat_url')
            cd ./cache
            curl -#kL ${paturl} -o ds.pat
            if [ -f "$GITHUB_WORKSPACE/syno-extractor.sh" ]; then
              sudo chmod +x $GITHUB_WORKSPACE/syno-extractor.sh && sudo $GITHUB_WORKSPACE/syno-extractor.sh ds.pat pat
            else
              curl -skL https://raw.githubusercontent.com/wjz304/Redpill_CustomBuild/main/syno-extractor.sh | sudo bash -s ds.pat pat
            fi
            tar -czf ${synomodel}_${synoversion}.pat -C ./pat/ . --warning=no-file-changed
            sha256newpat=$(sha256sum ${synomodel}_${synoversion}.pat | awk '{print $1}')
            sha256zImage=$(sha256sum ./pat/zImage | awk '{print $1}')
            sha256ramdisk=$(sha256sum ./pat/rd.gz | awk '{print $1}')
            isDT=$([ -f "pat/model.dtb" ] && echo true || echo false)
            echo sha256newpat: ${sha256newpat}
            echo sha256zImage: ${sha256zImage} 
            echo sha256ramdisk: ${sha256ramdisk}
            echo isDT: ${isDT}
            sudo rm -rf ds.pat oldpat.tar.gz synoesp pat
            cd ..
            jq -r .os.sha256 ${configfile}
            sed -i "s/$(jq -r .os.sha256 ${configfile})/${sha256newpat}/g" ${configfile}
          }
          function setsynoarch() {
            # jq: error: xxxx/0 is not defined at <top-level> : --arg xxxx "${xxxx}" ' ... $xxxx ...
            if [ -f "$GITHUB_WORKSPACE/docs/models.json" ]; then
              synoarch=$(jq -r --arg model "$1" '. | map(select(.Model == $model)) | .[].PackageArch' $GITHUB_WORKSPACE/docs/models.json)
            else
              synoarch=$(curl -skL https://raw.githubusercontent.com/wjz304/Redpill_CustomBuild/main/docs/models.json | jq -r --arg model "$1" '. | map(select(.Model == $model)) | .[].PackageArch')
            fi
            synoarch=${synoarch,,}
            echo ${synoarch}
          }
          # å¼€å§‹è¡¨æ¼”
          echo "============================ç¼–è¯‘å¼€å§‹============================"
          repository=${{ env.repository }}
          repo=$(echo ${repository} | awk -F'_' '{print $1}')
          branch=$(echo ${repository} | awk -F'_' '{print $2}')
          lkm=${{ env.lkm }}
          bArgs="BRP_DEBUG=1 "
          if [ ${repository} != 'pocopico_develop' -a ${repository} != 'wjz304_test-dev' ]; then 
            bArgs+='BRP_JUN_MOD=1 '
          fi
          git clone -b ${branch} https://github.com/${repo}/redpill-load redpill-load
          # # submodule
          # [ -d redpill-load/ext/recreate-zImage ] && rm -rf redpill-load/ext/recreate-zImage
          # git clone -b master https://github.com/kiler129/recreate-zImage.git redpill-load/ext/recreate-zImage
          # sudo chmod -R a+x redpill-load/ext
          # find redpill-load/ext -type f -name '*.sh' -exec ls -al '{}' +
          #å®¹é”™
          echo "============================â†“ å®¹é”™ â†“============================="
          # curl -skL https://raw.githubusercontent.com/wjz304/Redpill_CustomBuild/main/typo.sh | bash -s ${repo} ${branch} redpill-load
          chmod a+x $GITHUB_WORKSPACE/typo.sh && $GITHUB_WORKSPACE/typo.sh ${repo} ${branch} redpill-load
          echo "============================â†‘ å®¹é”™ â†‘============================="
          cp user_config.json redpill-load/user_config.json
          cd redpill-load
          model=${{ env.model }}
          version=${{ env.version }}
          platform=${{ env.platform }}
          synomodel=$(echo ${model,,} | sed 's/+/p/g')                                   # DS3622xs+ => ds3622xsp
          synoversion=$(echo ${version} | awk -F - '{print $2}')                         # 7.0.1-42218 => 42218
          synoarch=$(echo ${platform} | awk -F - '{print $1}')
          synokver=$(echo ${platform} | awk -F - '{print $2}')
          # 7.1 è§£å¯†PAT
          echo "===========================7.1+ è§£å¯†PAT==========================="
          if [[ "${version}" > "7.0.1-42218" ]]; then 
            exdsmpat ${model} ${version}
          fi
          # redpill.ko
          if [ ! -e ./redpill.ko ]; then
            echo "======================Download redpill.ko============================="
            lkmUrl=https://github.com/wjz304/rp-ext/raw/main/
            rpUrl=$(curl -skL "${lkmUrl}/lkms.json" | jq -r --arg rpko "rp-${platform}-${lkm}.ko.gz" '.[$rpko] | .url')
            if [ -n "${rpUrl}" ]; then
              curl -skL "${rpUrl}" -o "rp-${platform}-${lkm}.ko.gz" || true
              gzip -dcv "rp-${platform}-${lkm}.ko.gz" > "./redpill.ko" || true
            fi
          fi
          if [ ! -e ./redpill.ko ]; then
            # echo "===========================Arpl redpill.ko==========================="
            # TAG=`curl -skL https://api.github.com/repos/fbelavenuto/redpill-lkm/releases/latest | grep "tag_name" | awk '{print substr($2, 2, length($2)-3)}'`
            # curl -#kL "https://github.com/fbelavenuto/redpill-lkm/releases/download/${TAG}/rp-lkms.zip" -o ./rp-lkms.zip
            # [ -f ./rp-lkms.zip ] && unzip ./rp-lkms.zip -d ./rp-lkms >/dev/null || true
            # [ -d ./rp-lkms ] && for file in ./rp-lkms/*; do [ "$(echo ${file} | grep ${platform}-${lkm})" != "" ] && gzip -dcv "${file}" > "./redpill.ko" || echo "${file}: No"; done
            if [ -f ./redpill.ko ]; then
              echo "====================Docker Build redpill.ko==========================="
              [ ${{ env.dev }} == '1' ] && lkmrepo="fbelavenuto" || lkmrepo="pocopico"
              git clone --recursive https://github.com/${lkmrepo}/redpill-lkm.git redpill-lkm
              mkdir redpill-lkm-output && chmod -R 777 redpill-lkm-output
              TOOLKIT_VER="latest"  # "7.1"  # "latest"
              sudo docker run -u 1000 --rm -t -v "${PWD}/redpill-lkm":/input -v "${PWD}/redpill-lkm-output":/output fbelavenuto/syno-compiler:${TOOLKIT_VER} compile-lkm ${synoarch}
              cp -fv ./redpill-lkm-output/redpill-${lkm}.ko ./redpill.ko || true
            fi
          fi
          if [ ! -e ./redpill.ko ]; then
            echo "===========================Build redpill.ko==========================="
            toolkittxz=ds.${synoarch}-${version::3}.dev.txz
            toolkitdir=usr/local/x86_64-pc-linux-gnu/x86_64-pc-linux-gnu/sys-root/usr/lib/modules/DSM-${version::3}/build
            curl -skL "https://global.download.synology.com/download/ToolChain/toolkit/${version::3}/${synoarch}/${toolkittxz}" -o ${toolkittxz}
            mkdir ${synoarch} && tar -C./${synoarch}/ -xf ${toolkittxz} ${toolkitdir}
            git clone -b master --depth=1 https://github.com/${repo}/redpill-lkm.git
            cd redpill-lkm
            # sed -i 's/   -std=gnu89/   -std=gnu89 -fno-pie/' ../${synoarch}/${toolkitdir}/Makefile
            make LINUX_SRC=../${synoarch}/${toolkitdir} dev-v${version::1}
            modinfo ./redpill.ko
          fi
          if [ "SA6400" == "${model}" ]; then
            curl -skL "https://github.com/wjz304/Redpill_CustomBuild/files/10734770/rp-epyc7002-5.10.55-${lkm}.ko.gz" -o "rp-epyc7002-5.10.55-${lkm}.ko.gz"
            gzip -dcv "rp-epyc7002-5.10.55-${lkm}.ko.gz" > "./redpill.ko"
          fi
          modinfo ./redpill.ko
          RPKOVER=$(modinfo --field=vermagic ./redpill.ko | awk '{print $1}')
          cp -fv ./redpill.ko ./ext/rp-lkm/redpill-linux-v${RPKOVER}.ko
          sudo chmod -R +x ./ext/rp-lkm
          RPKOOLD=`echo $(grep "@@@EXT@@@/rp-lkm" ./config/${model}/${version}/config.json | sed -r 's|"@@@EXT@@@/(.*)":(.*)|\1|')`  # `echo $P` å»é¦–å°¾ç©ºæ ¼
          if [ ! "${RPKOOLD}" == "rp-lkm/redpill-linux-v${RPKOVER}.ko" ]; then
            echo "change ./config/${model}/${version}/config.json from ${RPKOOLD} to rp-lkm/redpill-linux-v${RPKOVER}.ko"
            sed -i "s|${RPKOOLD}|rp-lkm/redpill-linux-v${RPKOVER}.ko|" ./config/${model}/${version}/config.json
          fi
          rpext=https://raw.githubusercontent.com/wjz304/rp-ext/master
          # æ·»åŠ  addons
          echo "===========================æ·»åŠ  addons ==========================="
          if [ -n "${{ env.addons }}" ]; then
            ext=${{ env.addons }}
            exts=(${ext//,/ })
            for item in ${exts[@]}
            do
              echo "addons ==> [${item}]"
              ./ext-manager.sh add "${rpext}/addons/${item}/rpext-index.json"
            done
          fi
          # æ·»åŠ  modules
          echo "===========================æ·»åŠ modules ==========================="
          if [ -n "${{ env.modules }}" ]; then
            ext=${{ env.modules }}
            exts=(${ext//,/ })
            for item in ${exts[@]}
            do
              echo "modules ==> [${item}]"
              ./ext-manager.sh add "${rpext}/modules/${item}/rpext-index.json"
            done
          fi
          # æ·»åŠ æ‰©å±•é©±åŠ¨
          echo "===========================æ·»åŠ ext3rds ==========================="
          if [ -n "${{ env.ext3rds }}" ]; then
            ext=${{ env.ext3rds }}
            exts=(${ext//,/ })
            for item in ${exts[@]}
            do
              echo "ext3rds ==> [${item}]"
              ./ext-manager.sh add "${item}"
            done
          fi
          #è‡ªå®šä¹‰æ“ä½œ
          if [ -f '../customshell.sh' ]; then
            if [ "${{ env.issueauth }}" == "${{ github.repository_owner }}" -o "${{ github.triggering_actor }}" == "${{ github.repository_owner }}" ]; then
              echo "============================è‡ªå®šä¹‰æ“ä½œ============================"
              cp ../customshell.sh customshell.sh
              chmod a+x customshell.sh
              source customshell.sh
            else
              echo "ç”±äºæƒé™å¤ªé«˜, é˜²æ­¢æœ‰äº›äººæ‰§è¡Œéæ³•æ“ä½œ, ä»…ä»“åº“ä½œè€…å¯æ“ä½œ, è¯·è”ç³»è¯¥ä»“åº“ç®¡ç†å‘˜æˆ–è€…forkåˆ°è‡ªå·±åä¸‹æ“ä½œ."
            fi
          fi
          # ç©ºé—´
          echo "==============================ç©ºé—´=============================="
          df -h
          # ç¼–è¯‘
          echo "==============================ç¼–è¯‘=============================="
          # sed -i "s|#!/usr/bin/env bash|#!/usr/bin/env -S bash -x|g" ./build-loader.sh
          sudo ${bArgs} BRP_USER_CFG=user_config.json BRP_PLATFORM_KERNELVERSION=${platform} ./build-loader.sh "${model}" "${version}"
          ls ./custom/extensions | grep -v txt > exts.txt
          ls -al ./custom/extensions
      - name: Generate release tag
        if: env.iscustom == 'true' && success()
        id: tag
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
          if [ ${{ env.issues }} == 'true' ]; then
            echo "### ${{ env.issueauth }}'s Redpill Custom" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‘‰ issues: [#${{ env.issuenumber }}](${{ github.event.issue.html_url }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ${{ github.triggering_actor }}'s Redpill Custom" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‘‰ "model": "${{ env.model }}"  " >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‘‰ "version": "${{ env.version }}"  " >> $GITHUB_STEP_SUMMARY
          fi
          if [ '${{ env.warinfo }}' != '' ]; then
            echo "  " >> $GITHUB_STEP_SUMMARY
            echo "â€¼ï¸â€¼ï¸â€¼ï¸  " >> $GITHUB_STEP_SUMMARY
            echo 'Body ä¸­å«æœ‰è‡ªå®šä¹‰çš„ ${{ env.warinfo }} æ•æ„Ÿä¿¡æ¯, ä¸ºé˜²æ­¢å…¶ä»–äººç›—ç”¨, å»ºè®®é™„ä»¶ä¸‹è½½å®Œæˆååˆ é™¤æ—¥å¿—å’Œé™„ä»¶.  ' >> $GITHUB_STEP_SUMMARY
            echo 'åœ¨ğŸ‘‰Issuesä¸‹è¯„è®º "delete builds" å³å¯åˆ è¯¥Issuesçš„æ‰€æœ‰å†å²ç¼–è¯‘è®°å½•.  ' >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f 'body#${{ env.issuenumber }}.txt' ]; then
            cp body#${{ env.issuenumber }}.txt redpill-load/body#${{ env.issuenumber }}.txt
            echo -e "\n\nBOOT:\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> redpill-load/body#${{ env.issuenumber }}.txt
          else
            echo -e "BOOT:\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> redpill-load/body#actions.txt
          fi
          configfile=./redpill-load/config/${{ env.model }}/${{ env.version }}/config.json
          paturl=$(cat ${configfile} | jq -r '.os .pat_url')
          echo -e "\nPAT:\n${paturl}" >> redpill-load/body#${{ env.issuenumber }}.txt
      - name: Upload to Artifacts
        if: env.iscustom == 'true' && success()
        uses: actions/upload-artifact@v3
        with:
          name: Redpill-${{ env.model }}-${{ env.version }}-${{ env.release_tag }}
          path: |
            redpill-load/exts.txt
            redpill-load/body*.txt
            redpill-load/user_config.json
            redpill-load/images/*.img
      - name: Generate release tag
        if: env.iscustom == 'false'
        run: |
          if [ ${{ env.issues }} == 'true' ]; then
            echo "### ${{ env.issueauth }}'s Redpill Custom" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ${{ github.triggering_actor }}'s Redpill Custom" >> $GITHUB_STEP_SUMMARY
          fi
          echo "ğŸ˜ ğŸ˜” ğŸ˜Ÿ ğŸ˜• ğŸ™ â˜¹ï¸ ğŸ˜£ ğŸ˜– ğŸ˜« ğŸ˜© ğŸ¥º ğŸ˜¢  " >> $GITHUB_STEP_SUMMARY
          echo "æ‚¨è‡ªå®šä¹‰ Redpill æ‰€å¡«å†™çš„ä¿¡æ¯æœ‰è¯¯, æ— æ³•è§¦å‘ç¼–è¯‘, è¯·å‚è€ƒæ¨¡æ¿å’Œé”™è¯¯æç¤ºå¯¹bodyè¿›è¡Œä¿®æ”¹å¹¶è¯·é‡æ–°è§¦å‘ç¼–è¯‘(Close & Reopen).  " >> $GITHUB_STEP_SUMMARY
          echo "`Error Info:`  " >> $GITHUB_STEP_SUMMARY
          echo "`${{ env.errinfo }}`  " >> $GITHUB_STEP_SUMMARY
          if [ '${{ env.warinfo }}' != '' ]; then
            echo "  " >> $GITHUB_STEP_SUMMARY
            echo "â€¼ï¸â€¼ï¸â€¼ï¸  " >> $GITHUB_STEP_SUMMARY
            echo 'Body ä¸­å«æœ‰è‡ªå®šä¹‰çš„ ${{ env.warinfo }} æ•æ„Ÿä¿¡æ¯, ä¸ºé˜²æ­¢å…¶ä»–äººç›—ç”¨, å»ºè®®ç¡®è®¤é”™è¯¯åŸå› ååˆ é™¤æ—¥å¿—å’Œé™„ä»¶.  ' >> $GITHUB_STEP_SUMMARY
            echo 'åœ¨ğŸ‘‰Issuesä¸‹è¯„è®º "delete builds" å³å¯åˆ ğŸ‘‰Issuesçš„æ‰€æœ‰å†å²ç¼–è¯‘è®°å½•.  ' >> $GITHUB_STEP_SUMMARY
          fi
      - name: Update Comment Finish
        if: env.issues == 'true' && env.iscustom == 'true' && success()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} æ‚¨å¥½.
            æ‚¨è‡ªå®šä¹‰çš„ Redpill å·²æ„å»ºå®Œæˆ. è¯·å‰å¾€ä¸‹é¢çš„ URL ä¸‹è½½.  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----  
            PS:  
            åœ¨Issuesä¸‹è¯„è®º "transfer" é™„ä»¶è½¬å¿«ä¼  ğŸš²->ğŸ. (è¯·å‹¿é‡å¤å‘, æ“ä½œæ—¶é—´ â‰ˆ æˆåŠŸä¸ªæ•° X 3åˆ†é’Ÿ). 
            åœ¨Issuesä¸‹è¯„è®º "delete builds" å³å¯åˆ è¯¥Issuesçš„æ‰€æœ‰å†å²ç¼–è¯‘è®°å½•.
            >  
            ----  
          emoji: hooray

      - name: Close Issues
        if: env.issues == 'true' && env.iscustom == 'true' && success()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.issuenumber }}

      - name: Update Comment Fail
        if: env.issues == 'true' && env.iscustom == 'true' && failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: replace
          body: |
            ${{ env.issueauth }} æ‚¨å¥½.
            æ‚¨è‡ªå®šä¹‰çš„ Redpill æ„å»ºå¤±è´¥. è¯·å‰å¾€ä¸‹é¢çš„ URL æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯å¯¹bodyè¿›è¡Œä¿®æ”¹å¹¶è¯·é‡æ–°è§¦å‘ç¼–è¯‘(Close & Reopen).  
            > ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
            ----
            PS:  
            åœ¨Issuesä¸‹è¯„è®º "delete builds" å³å¯åˆ è¯¥Issuesçš„æ‰€æœ‰å†å²ç¼–è¯‘è®°å½•.
            >  
            ----  
          emoji: confused

      - name: Update Comment Warinfo
        if: env.issues == 'true' && env.warinfo != ''
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.comment.outputs.comment-id }}
          update-mode: append
          body: |
            >
            ----
            â€¼ï¸â€¼ï¸â€¼ï¸  
            `Body ä¸­å«æœ‰è‡ªå®šä¹‰çš„ ${{ env.warinfo }} æ•æ„Ÿä¿¡æ¯, ä¸ºé˜²æ­¢å…¶ä»–äººç›—ç”¨, å»ºè®®é™„ä»¶ä¸‹è½½å®Œæˆ/ç¡®è®¤é”™è¯¯åŸå› ååˆ é™¤æ—¥å¿—å’Œé™„ä»¶.`
            `åœ¨Issuesä¸‹è¯„è®º "delete builds" å³å¯åˆ Issuesçš„æ‰€æœ‰å†å²ç¼–è¯‘è®°å½•.`  
            >
            ----
          emoji: eyes
Footer
Â© 2023 GitHub, Inc.
Footer navigation
Terms
Privacy
Security
Status
Docs
